#! /bin/bash

# download HTML file of CVE entry
# possibly replace filename with shell positional argument
#wget https://access.redhat.com/security/cve/CVE-2016-8625



# get first occurrence of the nymerical part of the CVE ID
CVE_NUM_ID=$(cat CVE-2016-8625 | egrep -oi "CVE-201[[:digit:]]-[0-9]{3,6}" | egrep -o -m1 "[0-9]{4}-[0-9]*")

# Get BZ ID from HTML file
BZ_NUM_ID=$(cat CVE-2016-8625 | egrep -o "(id=)1[[:digit:]]{6}" | egrep -o "[0-9]*")

# get full issues summary
SUMMARY_FULL=$(cat CVE-2016-8625 | egrep -o -m1 "CVE-201[[:digit:]]-[0-9]{3,6} [a-Z]*:[[:space:]][a-Z,0-9,[:space:]]*")

# Get affected compoent and summary values from issue desc

# process full summary to obtain:

# affected compoennt name
COMPONENT_NAME=$(echo $SUMMARY_FULL | egrep -o "[a-z]*:" | egrep -o "[a-z]*")

# summary text
SUMMARY_TEXT=$(echo $SUMMARY_FULL | egrep -o ":[[:space:]][a-Z,0-9,[:space:]]*" | egrep -o "[a-Z,0-9,[:space:]]*[a-z]*")

# export replaceable values as anvironment variables to allow substitution
export CVE_NUM_ID
export COMPONENT_NAME
export SUMMARY_TEXT
export BZ_NUM_ID

# substitute values and write to file
# any way to do this without using envsubst
envsubst < test-template.adoc >> test-output.adoc

# echo extracted variable values
echo "Auto-generated RN entry for CVE-${CVE_NUM_ID}"
echo "============"
echo "Substituted extracted values:"
echo "============"
echo "CVE ID: CVE-${CVE_NUM_ID}"
echo "Affected Component: ${COMPONENT_NAME}"
echo "Issues Summary: ${SUMMARY_TEXT}"
echo "Bugzilla ID: ${BZ_NUM_ID}"
echo "============"

#TODO: rm the html when done
# rm $HTML_FILENAME

exit 0
